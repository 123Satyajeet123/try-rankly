📋 [LLM MODELS] Configured: {
  openai: 'openai/gpt-4o',
  gemini: 'google/gemini-2.5-flash',
  claude: 'anthropic/claude-3.5-sonnet',
  perplexity: 'perplexity/sonar-pro'
}
🧪 PromptTestingService initialized (deterministic scoring)
📊 MetricsAggregationService initialized
🚀 Rankly Backend API running on port 5000
📊 Health check: http://localhost:5000/health
📚 API info: http://localhost:5000/api
🌍 Environment: development
🔗 Frontend URL: http://localhost:3000
✅ MongoDB connected

🧹 Running startup cleanup...

🧹 [CLEANUP] Starting orphaned prompts cleanup...
📊 [CLEANUP] Found 30 topics and 19 personas
❌ [CLEANUP] Found 0 orphaned prompts
✅ [CLEANUP] Orphaned prompts cleanup complete


🧹 [CLEANUP] Starting orphaned test results cleanup...
❌ [CLEANUP] Found 0 orphaned test results
✅ [CLEANUP] Orphaned test results cleanup complete

✅ Startup cleanup complete


======================================================================
🧪 [API ENDPOINT] POST /api/prompts/test
👤 User ID: 68e7ef58da34c5124ad5fb1c
⏰ Request time: 2025-10-09T18:39:07.831Z
======================================================================

🔍 [VALIDATION] Checking for existing prompts...
✅ [VALIDATION] Found 30 active prompts
📊 [START] Testing prompts across 4 LLMs (limited to 2 for testing)...

============================================================
🎯 [TEST START] Starting prompt testing for user: 68e7ef58da34c5124ad5fb1c
📅 Timestamp: 2025-10-09T18:39:07.856Z
============================================================

🔍 [QUERY] Fetching active prompts for user 68e7ef58da34c5124ad5fb1c...
🔍 [FILTER] Only fetching prompts with topicId, personaId, and queryType
⚠️  [TESTING MODE] Limited to 2 prompts to save API costs
✅ [QUERY] Found 2 prompts in database
📊 [INFO] Prompts breakdown:
   1. What makes Stripe a good choice for payment proces...
      Raw topicId type: object, value: {
  _id: new ObjectId('68e7ff845786bb21b244432f'),
  userId: new ObjectId('68e7ef58da34c5124ad5fb1c'),
  name: 'Global Payment Processing',
  selected: true,
  description: "Stripe's core service is enabling businesses to accept and optimize payments worldwide, supporting 135+ currencies and local payment methods for higher conversion rates.",
  keywords: [
    'global payments',
    'multi-currency',
    'payment processing',
    'local payment methods',
    'cross-border payments'
  ],
  priority: 'High',
  source: 'ai',
  promptCount: 10,
  createdAt: 2025-10-09T18:31:32.234Z,
  updatedAt: 2025-10-09T18:31:48.686Z,
  __v: 0
}
      Raw personaId type: object, value: {
  _id: new ObjectId('68e7ff845786bb21b244433f'),
  userId: new ObjectId('68e7ef58da34c5124ad5fb1c'),
  type: 'E-commerce Business Owner',
  description: 'Responsible for managing online sales and ensuring smooth payment processing. They face challenges in integrating payment systems, managing subscriptions, and preventing fraud. They use Stripe for secure payment processing, subscription management, and fraud prevention tools.',
  selected: true,
  painPoints: [
    'Complex payment integration',
    'Subscription management',
    'Fraud prevention'
  ],
  goals: [
    'Streamline payment processes',
    'Increase revenue through subscriptions',
    'Reduce fraud losses'
  ],
  relevance: 'High',
  source: 'ai',
  createdAt: 2025-10-09T18:31:32.490Z,
  updatedAt: 2025-10-09T18:31:32.491Z,
  __v: 0
}
      Topic: Global Payment Processing (ID: 68e7ff845786bb21b244432f)
      Persona: E-commerce Business Owner (ID: 68e7ff845786bb21b244433f)
      QueryType: Navigational
   2. What are the best global payment processing soluti...
      Raw topicId type: object, value: {
  _id: new ObjectId('68e7ff845786bb21b244432f'),
  userId: new ObjectId('68e7ef58da34c5124ad5fb1c'),
  name: 'Global Payment Processing',
  selected: true,
  description: "Stripe's core service is enabling businesses to accept and optimize payments worldwide, supporting 135+ currencies and local payment methods for higher conversion rates.",
  keywords: [
    'global payments',
    'multi-currency',
    'payment processing',
    'local payment methods',
    'cross-border payments'
  ],
  priority: 'High',
  source: 'ai',
  promptCount: 10,
  createdAt: 2025-10-09T18:31:32.234Z,
  updatedAt: 2025-10-09T18:31:48.686Z,
  __v: 0
}
      Raw personaId type: object, value: {
  _id: new ObjectId('68e7ff845786bb21b244433f'),
  userId: new ObjectId('68e7ef58da34c5124ad5fb1c'),
  type: 'E-commerce Business Owner',
  description: 'Responsible for managing online sales and ensuring smooth payment processing. They face challenges in integrating payment systems, managing subscriptions, and preventing fraud. They use Stripe for secure payment processing, subscription management, and fraud prevention tools.',
  selected: true,
  painPoints: [
    'Complex payment integration',
    'Subscription management',
    'Fraud prevention'
  ],
  goals: [
    'Streamline payment processes',
    'Increase revenue through subscriptions',
    'Reduce fraud losses'
  ],
  relevance: 'High',
  source: 'ai',
  createdAt: 2025-10-09T18:31:32.490Z,
  updatedAt: 2025-10-09T18:31:32.491Z,
  __v: 0
}
      Topic: Global Payment Processing (ID: 68e7ff845786bb21b244432f)
      Persona: E-commerce Business Owner (ID: 68e7ff845786bb21b244433f)
      QueryType: Commercial Investigation

🔗 [URL] Fetching latest URL analysis...
✅ [URL] Found URL analysis: https://stripe.com (ID: 68e7ff845786bb21b244430f)

🏢 [CONTEXT] Fetching brand context for scoring...
✅ [CONTEXT] Brand: Stripe, Competitors: 3

🔄 [BATCHING] Processing 2 prompts in 1 batches (size: 2)

────────────────────────────────────────────────────────────
📦 [BATCH 1/1] Processing 2 prompts
────────────────────────────────────────────────────────────

🔬 [PROMPT] Testing: "What makes Stripe a good choice for payment processing?..."
   Prompt ID: 68e7ff935786bb21b2444368
   Query Type: Navigational
   Topic ID: 68e7ff845786bb21b244432f
   Persona ID: 68e7ff845786bb21b244433f
   🚀 [STEP 1] Sending to 4 LLMs in parallel...
      🌐 [API] Calling openai (openai/gpt-4o)...
      🌐 [API] Calling gemini (google/gemini-2.5-flash)...
      🌐 [API] Calling claude (anthropic/claude-3.5-sonnet)...
      🌐 [API] Calling perplexity (perplexity/sonar-pro)...

🔬 [PROMPT] Testing: "What are the best global payment processing solutions for e-..."
   Prompt ID: 68e7ff935786bb21b244436a
   Query Type: Commercial Investigation
   Topic ID: 68e7ff845786bb21b244432f
   Persona ID: 68e7ff845786bb21b244433f
   🚀 [STEP 1] Sending to 4 LLMs in parallel...
      🌐 [API] Calling openai (openai/gpt-4o)...
      🌐 [API] Calling gemini (google/gemini-2.5-flash)...
      🌐 [API] Calling claude (anthropic/claude-3.5-sonnet)...
      🌐 [API] Calling perplexity (perplexity/sonar-pro)...
      📎 [CITATIONS] Extracted 28 citations from gemini
      ✅ [API] gemini responded in 6789ms (1167 tokens, 4707 chars, 28 citations)
      📎 [CITATIONS] Extracted 17 citations from gemini
      ✅ [API] gemini responded in 6823ms (1187 tokens, 4590 chars, 17 citations)
      📎 [CITATIONS] Extracted 18 citations from perplexity
      ✅ [API] perplexity responded in 9245ms (762 tokens, 2839 chars, 18 citations)
      📎 [CITATIONS] Extracted 6 citations from openai
      ✅ [API] openai responded in 10055ms (668 tokens, 2635 chars, 6 citations)
      📎 [CITATIONS] Extracted 16 citations from openai
      ✅ [API] openai responded in 14605ms (918 tokens, 3417 chars, 16 citations)
      📎 [CITATIONS] Extracted 14 citations from claude
      ✅ [API] claude responded in 18087ms (710 tokens, 1973 chars, 14 citations)
      📎 [CITATIONS] Extracted 32 citations from claude
      ✅ [API] claude responded in 18314ms (835 tokens, 2652 chars, 32 citations)
   ✅ [STEP 1] LLM calls complete in 18.33s (4/4 successful)
   🎯 [STEP 2] Scoring 4 responses...
   📝 [OPENAI] Response received (10055ms, 668 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 1, Citations: 6
      📊 [SCORING] Scores - Visibility: 100, Overall: 100
   ✅ [OPENAI] Score calculated - Visibility: 100/100, Overall: 100/100
      💾 [SAVE] Preparing to save test result for openai
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Navigational
      📊 [SAVE] Extracted 1 brand entries with complete metrics
   📝 [GEMINI] Response received (6789ms, 1167 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 1, Citations: 28
      📊 [SCORING] Scores - Visibility: 100, Overall: 100
   ✅ [GEMINI] Score calculated - Visibility: 100/100, Overall: 100/100
      💾 [SAVE] Preparing to save test result for gemini
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Navigational
      📊 [SAVE] Extracted 1 brand entries with complete metrics
   📝 [CLAUDE] Response received (18314ms, 835 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 1, Citations: 26
      📊 [SCORING] Scores - Visibility: 100, Overall: 100
   ✅ [CLAUDE] Score calculated - Visibility: 100/100, Overall: 100/100
      💾 [SAVE] Preparing to save test result for claude
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Navigational
      📊 [SAVE] Extracted 4 brand entries with complete metrics
   📝 [PERPLEXITY] Response received (9245ms, 762 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 1, Citations: 18
      📊 [SCORING] Scores - Visibility: 100, Overall: 100
   ✅ [PERPLEXITY] Score calculated - Visibility: 100/100, Overall: 100/100
      💾 [SAVE] Preparing to save test result for perplexity
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Navigational
      📊 [SAVE] Extracted 1 brand entries with complete metrics
      ✅ [SAVE] Test result saved successfully with 1 brand metrics
   💾 [OPENAI] Saved to database (ID: 68e8015ec9dc0cdb11cbc82b)
      ✅ [SAVE] Test result saved successfully with 4 brand metrics
   💾 [CLAUDE] Saved to database (ID: 68e8015ec9dc0cdb11cbc87f)
      ✅ [SAVE] Test result saved successfully with 1 brand metrics
   💾 [PERPLEXITY] Saved to database (ID: 68e8015ec9dc0cdb11cbc8af)
      ✅ [SAVE] Test result saved successfully with 1 brand metrics
   💾 [GEMINI] Saved to database (ID: 68e8015ec9dc0cdb11cbc842)
   ✅ [STEP 2] Scoring complete in 0.13s (4/4 successful)
   ✨ [COMPLETE] Prompt testing finished

      📎 [CITATIONS] Extracted 24 citations from perplexity
      ✅ [API] perplexity responded in 25981ms (1154 tokens, 4312 chars, 24 citations)
   ✅ [STEP 1] LLM calls complete in 25.99s (4/4 successful)
   🎯 [STEP 2] Scoring 4 responses...
   📝 [OPENAI] Response received (14605ms, 918 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 9, Citations: 2
      📊 [SCORING] Scores - Visibility: 94, Overall: 94
   ✅ [OPENAI] Score calculated - Visibility: 94/100, Overall: 94/100
      💾 [SAVE] Preparing to save test result for openai
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Commercial Investigation
      📊 [SAVE] Extracted 4 brand entries with complete metrics
   📝 [GEMINI] Response received (6823ms, 1187 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 5, Citations: 8
      📊 [SCORING] Scores - Visibility: 96, Overall: 96
   ✅ [GEMINI] Score calculated - Visibility: 96/100, Overall: 96/100
      💾 [SAVE] Preparing to save test result for gemini
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Commercial Investigation
      📊 [SAVE] Extracted 3 brand entries with complete metrics
   📝 [CLAUDE] Response received (18087ms, 710 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 2, Citations: 2
      📊 [SCORING] Scores - Visibility: 84, Overall: 84
   ✅ [CLAUDE] Score calculated - Visibility: 84/100, Overall: 84/100
      💾 [SAVE] Preparing to save test result for claude
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Commercial Investigation
      📊 [SAVE] Extracted 4 brand entries with complete metrics
   📝 [PERPLEXITY] Response received (25981ms, 1154 tokens)
      🎯 [SCORING] Calculating deterministic score for: Stripe
      📊 [SCORING] Metrics - Brand: Stripe, Mentioned: true, Position: 1, Citations: 2
      📊 [SCORING] Scores - Visibility: 99, Overall: 99
   ✅ [PERPLEXITY] Score calculated - Visibility: 99/100, Overall: 99/100
      💾 [SAVE] Preparing to save test result for perplexity
      📋 [SAVE] Extracted IDs - topicId: 68e7ff845786bb21b244432f, personaId: 68e7ff845786bb21b244433f, queryType: Commercial Investigation
      📊 [SAVE] Extracted 4 brand entries with complete metrics
      ✅ [SAVE] Test result saved successfully with 4 brand metrics
   💾 [OPENAI] Saved to database (ID: 68e80165c9dc0cdb11cbc8d3)
      ✅ [SAVE] Test result saved successfully with 4 brand metrics
   💾 [CLAUDE] Saved to database (ID: 68e80165c9dc0cdb11cbc913)
      ✅ [SAVE] Test result saved successfully with 3 brand metrics
   💾 [GEMINI] Saved to database (ID: 68e80165c9dc0cdb11cbc8f0)
      ✅ [SAVE] Test result saved successfully with 4 brand metrics
   💾 [PERPLEXITY] Saved to database (ID: 68e80166c9dc0cdb11cbc92a)
   ✅ [STEP 2] Scoring complete in 0.09s (4/4 successful)
   ✨ [COMPLETE] Prompt testing finished

✅ [BATCH 1] Complete in 26.09s - Success: 8, Failed: 0

📊 [SUMMARY] Calculating aggregate statistics...
   📊 [CALC] Valid results: 8, Completed: 8

============================================================
✅ [TEST COMPLETE] All testing finished
📊 Total Tests: 8
✅ Completed: 8
❌ Failed: 0
📈 Avg Visibility: 97%
🎯 Brand Mention Rate: 100%
🏆 Best LLM: perplexity
============================================================


======================================================================
✅ [API RESPONSE] Testing complete
⏱️  Total duration: 26.23s
📊 Results: 8/8 successful
======================================================================

