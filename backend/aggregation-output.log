🧠 InsightsGenerationService initialized
📊 MetricsAggregationService initialized
✅ Connected to MongoDB
📋 Using user ID from command line: 68e9892f5e894a9df4c401ce

============================================================
🔄 RE-AGGREGATING METRICS FROM PROMPT TESTS
============================================================
👤 User ID: 68e9892f5e894a9df4c401ce
⏰ Started: 2025-10-11T14:56:06.636Z
============================================================

📊 Found 76 completed prompt tests
📝 Unique prompts: 20
🤖 Platforms tested: 4
📚 Topics: 2
👥 Personas: 2

🔄 Running aggregation...

📊 Starting metrics aggregation for user: 68e9892f5e894a9df4c401ce
✅ Found 76 tests to aggregate
  → Aggregating OVERALL metrics
     ✅ Total unique prompts where HDFC Bank appears: 17
     📊 Total mentions across all tests: 474
     📈 Visibility Score: 85% (17 / 20 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 4
     📊 Total mentions across all tests: 59
     📈 Visibility Score: 20% (4 / 20 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 2
     📊 Total mentions across all tests: 25
     📈 Visibility Score: 10% (2 / 20 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 2
     📊 Total mentions across all tests: 31
     📈 Visibility Score: 10% (2 / 20 unique prompts)
  → Aggregating PLATFORM metrics
     ✅ Total unique prompts where HDFC Bank appears: 17
     📊 Total mentions across all tests: 106
     📈 Visibility Score: 85% (17 / 20 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 3
     📊 Total mentions across all tests: 15
     📈 Visibility Score: 15% (3 / 20 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 2
     📊 Total mentions across all tests: 3
     📈 Visibility Score: 10% (2 / 20 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 2
     📊 Total mentions across all tests: 7
     📈 Visibility Score: 10% (2 / 20 unique prompts)
     ✅ Total unique prompts where HDFC Bank appears: 14
     📊 Total mentions across all tests: 181
     📈 Visibility Score: 82.35% (14 / 17 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 4
     📊 Total mentions across all tests: 28
     📈 Visibility Score: 23.53% (4 / 17 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 2
     📊 Total mentions across all tests: 12
     📈 Visibility Score: 11.76% (2 / 17 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 1
     📊 Total mentions across all tests: 7
     📈 Visibility Score: 5.88% (1 / 17 unique prompts)
     ✅ Total unique prompts where HDFC Bank appears: 17
     📊 Total mentions across all tests: 103
     📈 Visibility Score: 85% (17 / 20 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 3
     📊 Total mentions across all tests: 8
     📈 Visibility Score: 15% (3 / 20 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 2
     📊 Total mentions across all tests: 6
     📈 Visibility Score: 10% (2 / 20 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 1
     📊 Total mentions across all tests: 9
     📈 Visibility Score: 5% (1 / 20 unique prompts)
     ✅ Total unique prompts where HDFC Bank appears: 16
     📊 Total mentions across all tests: 84
     📈 Visibility Score: 84.21% (16 / 19 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 2
     📊 Total mentions across all tests: 8
     📈 Visibility Score: 10.53% (2 / 19 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 2
     📊 Total mentions across all tests: 8
     📈 Visibility Score: 10.53% (2 / 19 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 1
     📊 Total mentions across all tests: 4
     📈 Visibility Score: 5.26% (1 / 19 unique prompts)
  → Aggregating TOPIC metrics
     ✅ Total unique prompts where HDFC Bank appears: 9
     📊 Total mentions across all tests: 241
     📈 Visibility Score: 100% (9 / 9 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 2
     📊 Total mentions across all tests: 34
     📈 Visibility Score: 22.22% (2 / 9 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 1
     📊 Total mentions across all tests: 5
     📈 Visibility Score: 11.11% (1 / 9 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 2
     📊 Total mentions across all tests: 31
     📈 Visibility Score: 22.22% (2 / 9 unique prompts)
     ✅ Total unique prompts where HDFC Bank appears: 8
     📊 Total mentions across all tests: 233
     📈 Visibility Score: 72.73% (8 / 11 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 2
     📊 Total mentions across all tests: 25
     📈 Visibility Score: 18.18% (2 / 11 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 1
     📊 Total mentions across all tests: 20
     📈 Visibility Score: 9.09% (1 / 11 unique prompts)
  → Aggregating PERSONA metrics
     ✅ Total unique prompts where HDFC Bank appears: 8
     📊 Total mentions across all tests: 223
     📈 Visibility Score: 80% (8 / 10 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 1
     📊 Total mentions across all tests: 28
     📈 Visibility Score: 10% (1 / 10 unique prompts)
     ✅ Total unique prompts where HDFC Bank appears: 9
     📊 Total mentions across all tests: 251
     📈 Visibility Score: 90% (9 / 10 unique prompts)
     ✅ Total unique prompts where ICICI Bank appears: 4
     📊 Total mentions across all tests: 59
     📈 Visibility Score: 40% (4 / 10 unique prompts)
     ✅ Total unique prompts where SBI Card appears: 2
     📊 Total mentions across all tests: 25
     📈 Visibility Score: 20% (2 / 10 unique prompts)
     ✅ Total unique prompts where Axis Bank appears: 1
     📊 Total mentions across all tests: 3
     📈 Visibility Score: 10% (1 / 10 unique prompts)
✅ Metrics aggregation complete
   Overall: saved
   Platforms: 4 saved
   Topics: 2 saved
   Personas: 2 saved
   Total calculations: 9
🧠 Generating AI-powered Performance Insights...
🧠 Starting AI-powered insights generation...
✅ LLM generated 4 insights
✅ Generated 4 insights
✅ AI Insights generated: 4 insights
   What's Working: 3
   Needs Attention: 1
💾 AI Insights saved to database
   Insights ID: new ObjectId('68ea7013239ec7f7b0ccc645')

============================================================
✅ AGGREGATION COMPLETE
============================================================
Metrics have been recalculated and saved to database
============================================================

🔍 Verifying re-aggregated metrics...

Overall Metrics Summary:
────────────────────────────────────────────────────────────
Total unique prompts: 20
Total responses (tests): 76
Total brands detected: 4

Brand Visibility Scores (should be 0-100%):
────────────────────────────────────────────────────────────
✅ 1. HDFC Bank
   Visibility Score: 85% (Rank #1)
   Appears in: 17 / 20 unique prompts
   Total mentions: 474
   Share of Voice: 80.48%
   Avg Position: 1.05
   Depth of Mention: 26.333%

✅ 2. ICICI Bank
   Visibility Score: 20% (Rank #2)
   Appears in: 4 / 20 unique prompts
   Total mentions: 59
   Share of Voice: 10.02%
   Avg Position: 6.67
   Depth of Mention: 2.9532%

✅ 3. SBI Card
   Visibility Score: 10% (Rank #3)
   Appears in: 2 / 20 unique prompts
   Total mentions: 25
   Share of Voice: 4.24%
   Avg Position: 8.14
   Depth of Mention: 1.6103%

✅ 4. Axis Bank
   Visibility Score: 10% (Rank #4)
   Appears in: 2 / 20 unique prompts
   Total mentions: 31
   Share of Voice: 5.26%
   Avg Position: 4.33
   Depth of Mention: 1.2825%

────────────────────────────────────────────────────────────

✅ Re-aggregation completed successfully!

Next steps:
  1. Check the metrics in MongoDB
  2. Test the dashboard API: GET /api/metrics/dashboard
  3. Verify frontend displays correctly

